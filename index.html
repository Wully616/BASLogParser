<!doctype html>
<html lang="en" class="h-100">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="Wully">

    <title>B&S Log Parser</title>



    <!-- Bootstrap core CSS -->
<link href="assets/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
      .bd-placeholder-img {
        font-size: 1.125rem;
        text-anchor: middle;
        -webkit-user-select: none;
        -moz-user-select: none;
        user-select: none;
      }

      @media (min-width: 768px) {
        .bd-placeholder-img-lg {
          font-size: 3.5rem;
        }
      }
    </style>

    
    <!-- Custom styles for this template -->
    <link href="cover.css" rel="stylesheet">
  </head>
  <body class="d-flex h-100 text-white bg-dark">
    
<div class="d-flex w-auto h-auto p-3 mx-auto flex-column">

  <main class="d-flex justify-content-center px-3">

    <div class="text-center">
        <h1>Wully's Blade and Sorcery U9.2 Log Parser</h1>
        <p class="lead">Upload your log file and we will recommend solutions</p>
        <h3>How to use:</h3>
        <div class="text-start">
            <ul class="list-styled ">
                <li class="ms-auto p-2">Copy the log location: <kbd class=" badge bg-primary">%userprofile%\AppData\LocalLow\WarpFrog\BladeAndSorcery\</kbd></li>
                <li class="ms-auto p-2">Click Browse below.</li>
                <li class="ms-auto p-2">Paste in the log location into the address bar in the popup window and press enter.</li>
                <li class="ms-auto p-2">Select the <kdb class="badge  bg-primary">Player.log</kdb> or <kdb class="badge  bg-primary">Player</kdb> file.</li>
                <li class="ms-auto p-2">Click Open.</li>
                <li class="ms-auto p-2">Wait for the results.</li>
            </ul>
            
          
            
            <p class="lead">
            <input type="file" id="file" name="file" accept=".log, .txt" href="#" class="btn btn-lg btn-secondary fw-bold border-white bg-white">
            </p>            
            <p class="lead">
                <a href="https://github.com/Wully616/BASLogParser" class="btn btn btn-light fw-bold ">Github: Wully616</a>
                <a href="https://discord.com/users/92696876612091904" target="_blank" class="btn btn btn-primary fw-bold ">Discord: Wully#4938</a>
                <a href="https://www.nexusmods.com/bladeandsorcery/users/873572?tab=user+files" target="_blank" class="btn btn btn-warning fw-bold ">Nexus: Wully616</a>
            </p>
            <p class="lead">
                If this app did not find an error in your log and you think there is one. Please send your log file to Wully on Discord and it will get added.
            </p>
            <p class="lead">
                If you still do not know what to do please reach out to someone on the <kbd class=" badge bg-primary">#modding-help</kbd> room on the <a class=" badge bg-primary" href="https://discord.gg/nqCR8KG">B&S Discord</a>
            </p>
        </div>
    </div>

  </main>


    <p id="status">Status</p>
    <table id="table_div" class="table table-sm table-dark table-striped">
    <thead>
        <tr>
            <th scope="col">Issue</th>
            <th scope="col">What was found</th>
            <th scope="col">Recommendation</th>
            <th scope="col">Comment</th>
        </tr>
        </thead>
    <tbody></tbody>
    <table>
        


  <footer class="mt-auto text-white-50">
    <p>All data is processed client side ( in your browser ) no data is stored by this site.</p>
  </footer>
</div>


    
  </body>
  <script>
    var catalogs = {};
    var results = [];
    var playerPath;
    //TODO: get the install path from the log

    function getPlayerPath(line){
        var rx = /Mono path\[0\] = '(.*\/)Managed'/g;
        var arr = rx.exec(line);     
        if(!arr){ return; }
        playerPath = arr[1];
    }

    function catalogDupes(){
        //find mods with catalog dupes
        Object.keys(catalogs).forEach(function (key) {
            if (catalogs[key].length > 1) {
                catalogs[key];
                var row = [
                    `<p class="badge bg-danger">Catalog Duplicate for ${key}</p> `,
                     catalogs[key],
                     `Delete the oldest catalog files <p class="badge bg-info">${playerPath}StreamingAssets\\Mods\\${key}\\</p>`,
                     "This normally happens when you install a mod incorrectly by copying over files. You should delete the old mod first then copy over the new version."]
               results.push(row);         
            }         
        });

    }

    function processOutput(){
        catalogDupes();
        
        $('#table_div tbody').empty();
        for (i in results) {
            $('#table_div > tbody:last').append('<tr><td class="word-wrap">'+results[i][0]+'</td><td class="word-wrap">'+results[i][1]+'</td><td class="word-wrap">'+results[i][2]+'</td><td class="word-wrap">'+results[i][3]+'</td></tr>');
        }

    }

    //TODO pirated?
    //https://discord.com/channels/327809947272478720/516724425131819009/829494493203922965

    //TODO outdated mods?
    //https://discord.com/channels/327809947272478720/516724425131819009/831305136373760030

    //TODO bad json
    function badJson(line){
        //check if its a json issue
        var rx = /loadMods : Cannot read file (.*\.json)/g;
        var arr = rx.exec(line);
        if(!arr) {return;}
        var path = arr[1].split(/[\/\\]/);
        var mod = path[0];
        //multiple types of json issues, like:
        
        // unexpected character after parsing
        var uprx = /loadMods : Cannot read file (.*\.json) \(After parsing a value an unexpected character was encountered: (.*)\. Path '(.*)', line (\d+), position (\d+)./g;
        var uparr = uprx.exec(line);
        if(uparr){
            var row = [
                    `<p class="badge bg-danger">Json error for mod: ${mod}</p> `,
                    `${line}`,
                     `In json file <p class="badge bg-info">${playerPath}StreamingAssets\\Mods\\${uparr[1]}</p> there is an unexpected character: <p class="badge bg-info">${uparr[2]}</p> on line ${uparr[4]}, ${uparr[5]} characters along the line. It may need to be removed, or you have your json syntax wrong.`,
                     "Json follows a strict syntax, paste the json files content into : <a href=\"https://jsonlint.com/\">Here<a> to give you more help."]
            results.push(row);  
        }

        // unexpected character in value
        var uvrx = /loadMods : Cannot read file (.*\.json) \(Unexpected character encountered while parsing value: (.*)\. Path '(.*)', line (\d+), position (\d+)./g;
        var uvarr = uvrx.exec(line);
        if(uvarr){
            var row = [
                    `<p class="badge bg-danger">Json error for mod: ${mod}</p> `,
                    `${line}`,
                     `In json file <p class="badge bg-info">${playerPath}StreamingAssets\\Mods\\${uvarr[1]}</p> there is an unexpected character: <p class="badge bg-info">${uvarr[2]}</p> on line ${uvarr[4]}, ${uvarr[5]} characters along the line. It may need to be removed, or you have your json syntax wrong.`,
                     "Json follows a strict syntax, paste the json files content into : <a href=\"https://jsonlint.com/\">Here<a> to give you more help."]
            results.push(row);  
        }
        //Invalid type specified for catalog data - normally means wrong name or classname
        var trx = /loadMods : Cannot read file (.*\.json) \(Type specified in JSON '(.*, .*), Version.*' is not compatible with '(.*), Assembly.*\. Path '(.*)', line (\d+), position (\d+)./g;
        var tarr = trx.exec(line);
        if(tarr){
            var row = [
                    `<p class="badge bg-danger">Json error for mod: ${mod}</p> `,
                    `${line}`,
                     `In json file <p class="badge bg-info">${playerPath}StreamingAssets\\Mods\\${tarr[1]}</p> the <p class="badge bg-info">${tarr[4]}</p> specified: <p class="badge bg-info">${tarr[2]}</p> on line ${tarr[5]}, ${tarr[6]} characters along the line is wrong and is not compatible with <p class="badge bg-info">${tarr[3]}</p>. You may have misspelled the type like ItemData or you have put the wrong class or dll name for your custom mod`,
                     "The types specified in the json files are defined by B&S, you can look at the base game json to check your using the right one or if you have a custom dll, make sure you use the correct naming of <p class=\"badge bg-info\">\"$type\": \"MyNameSpace.MyClass\", MyDllName\"</p>"]
            results.push(row);  
        }


        //loadMods : Cannot read file EhGuppy's Jewel Weapons\Effects\Effect_ImbuePurpleFireRagdoll.json (After parsing a value an unexpected character was encountered: ". Path 'modules[0].mainNoHdrColorEnd.g', line 49, position 8.) 
        //https://discord.com/channels/327809947272478720/516724425131819009/833086321537974302
    }
    function jsonVersionMismatches(line){
        //looking for things like
        //JSON loader - Version mismatch (file 2, current 4) 
        var rx = /JSON loader - Version mismatch \(file ([\d]*), current ([\d]+)\).*:(.*)\\(.*)/g;
        var arr = rx.exec(line);
        if(!arr){ return; }
        var row = [
                    `<p class="badge bg-danger">Json file version mismatch for mod: ${arr[3]}</p> `,
                    `${arr[0]}`,
                     `Version in json file <p class="badge bg-info">${playerPath}StreamingAssets\\Mods\\${arr[3]}\\${arr[4]}</p> is ${arr[1]}, change it to ${arr[2]}`,
                     "The json file has the incorrect version identifier. These may change with game updates and old mods may then have an old version"]
        results.push(row);  
    }

    function resourceExceptions(line){
        //looking for exceptions when loading bundles
        var rx = /Exception encountered in operation (.*),.*:(.*)/g;
        var arr = rx.exec(line);
        if(!arr){ return; }
        var match = arr[0];
        rx = /StreamingAssets[\\/]Mods[\\/](.*)[\\/]/g;
        var modArr = rx.exec(match);
        var mod = "Unidentified Mod";
        if(modArr){
            mod = modArr[1];
        }
        var error = arr[1];
        var where = arr[2];
        var row = [
                    `<p class="badge bg-danger">Exception for ${mod}</p> `,
                    `${error} - ${where}`,
                     `Try removing the mod at <p class="badge bg-info">${playerPath}StreamingAssets\\Mods\\${mod}\\</p>`,
                     "The mod may have been built incorrectly, or has been installed incorrectly or is for an old version of B&S"]
        results.push(row);  
    }
    function readCatalogs(line){
        var rx = /Successfully loaded content catalog at path.*BladeAndSorcery_Data\/StreamingAssets\\Mods\\(.*)\\(catalog_.*.json)/g;
        var arr = rx.exec(line);
        //mod name is key
        //if we dont have it already, create list
        if(!arr){ return; }

        if(!catalogs[arr[1]]){
            catalogs[arr[1]] = [];    
        }
        catalogs[arr[1]].push(arr[2]); //add catalog to list
        
    }

    function parseRows(line){

        getPlayerPath(line);
        readCatalogs(line);
        
        resourceExceptions(line);
        jsonVersionMismatches(line);
        badJson(line);

    }
    async function readFile(file) {
        return await new Promise((resolve, reject) => {
            catalogs = {};
            results = [];
            var reader = new LineReader(file);
            
            reader.readLines(function(line){
                parseRows(line);
            }, () => {
                resolve("done");
            });
          

        });
    }


    const fileSelector = document.getElementById('file');
    const output = document.getElementById('output');
    const status = document.getElementById('status');

    if (window.FileList && window.File && window.FileReader) {
        fileSelector.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            console.log(file);
            status.innerHTML = "Parsing log...";
            const contents = await readFile(file);
            status.innerHTML = "Finished parsing...Processing Output";
            await processOutput();
            status.innerHTML = "Finished processing output.";
           
        });
    }

  </script>
 <script src="js/LineReader.js"></script> 
 <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
</html>
